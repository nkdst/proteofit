---
title: "GSEA analysis"
author: "Nick Diercksen"
output:
  html_notebook:
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(fgsea)
library(ggplot2)
```


```{r}
load("./data/Robjects/02_annot.RData")
load("./data/Robjects/03_DDS.RData")
```



# creating ranks

-   adding annotations (entrez id, ...) to results table: ...
-   using `stat` (Wald Test), as ranks metric



```{r}
getRanks <- function(res, annot) {
  res.annot <- as.data.frame(res) %>%
    tibble::rownames_to_column("GeneID") %>%
    dplyr::rename(logFC = log2FoldChange, FDR = padj) %>%
    left_join(filter(annot,!is.na(entrezgene_id)),
              "GeneID") 
  
  ranks <- res.annot$stat
  names(ranks) <- res.annot$entrezgene_id
  return(ranks)
}
# TODO: sort the ranks!

ranks.gastroc <- getRanks(res.gastroc, annot)

ranks.soleus <- getRanks(res.soleus, annot)
```

## barplots of ranks

```{r}
# no idea how to plot this with ggplot (one column) ...

# ggpubr::ggarrange(
  barplot(sort(ranks.gastroc, decreasing = T), main = "Wald Test ranks, gastroc")
  barplot(sort(ranks.soleus, decreasing = T), main = "Wald Test ranks, soleus")
# )
```

# loading pathways

Pathways are provided by <http://www.gsea-msigdb.org/gsea/msigdb/mouse/collections.jsp>

For now the Canonical pathways are used. These gene sets represent biological a biological process. They are composed from the following databases taking a subset of CP:

| database     | gene sets |
|--------------|-----------|
| BioCarta     | 252       |
| Reactome     | 1249      |
| WikiPathways | 186       |

```{r}
# MH <- qusage::read.gmt("./data/pathways/mh.all.v2022.1.Mm.entrez.gmt") # 50 hallmark genes
# M2 <- qusage::read.gmt("./data/pathways/m2.all.v2022.1.Mm.entrez.gmt") # curated gene set with 2600 genes
CGP <- qusage::read.gmt("./data/pathways/m2.cp.v2022.1.Mm.entrez.gmt") # canonical pathways (1687 gene sets)
```

# applying fgsea

```{r }
fgseaRes <- fgsea(pathways = CGP, 
                  stats    = ranks.gastroc,
                  minSize  = 15,
                  maxSize  = 500)
```

```{r}
top.pathways <- head(fgseaRes[order(padj, -abs(NES)), ], n=9)
top.pathways
```

## Enrichment score plot

as example the gene with the

```{r}
# TODO: plot the top 9 and add labels with description
top1.pathway <- top.pathways[1]$pathway
plotEnrichment(CGP[[top1.pathway]], ranks.gastroc) +
  ggtitle(label=top1.pathway)
```

```{r}
library(ggpubr)
library(gridExtra)

# TODO: create plot for top up and down regulated pathways

top9.pathways <- top.pathways[1:9]$pathway
plot.list <- list()
  lims <- list("x" = c(0,17000), "y" = c(-0.8,0.0))
for (i in 1:length(top9.pathways)) {
# TODO: how can I use facet_wrap for this?
  pathway <- top9.pathways[i]
  plt <- plotEnrichment(CGP[[pathway]], ranks.gastroc) +
    # TODO: adjust yaxis to the same scale
    # TODO: keep axis.text.x only on the lower row
    # TODO: keep axis.text.y only on the right column
    theme(
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
    ) +
    coord_cartesian(xlim = lims$x, ylim = lims$y)
  plot.list[[i]] <- plt
}


arrange_plts <- function(plt.list, plt.labels=T) {
  nplts <- length(plt.list)
  plt <- plt.list[1]
  xlab <- plt$labels$x
  ylab <- plt$labels$y
  
  
  # set axis to the same scale
  lims <- list("x" = c(0,17000), "y" = c(-0.8,0.0))
  
  # remove axis
  
  # arrange the plots
  fig_labels <- ifelse(plt.labels, "", LETTERS[1:nplts])
  figure <- ggpubr::ggarrange(plotlist = plt.list,
                              labels = fig_labels) %>% 
    annotate_figure(
                  left = text_grob(ylab, rot = 90),
                  bottom = text_grob(xlab)
                  )
  
  return(figure)
}


arrange_plts(plot.list, plt.labels = top9.pathways)

plot_labels <-
    data.frame("label" = LETTERS[1:9], "pathway" = top9.pathways)
knitr::kable(caption = "plot labels", plot_labels)
```


## GSEA table plot

all significant pathways:

```{r}
# creating up and down regulated pathway vectors separately to maintain order
topUp <- fgseaRes %>%
  filter(ES > 0, padj < 0.01) %>%
  dplyr::top_n(10, wt=-padj)
topDown <- fgseaRes %>%
  filter(ES < 0, padj < 0.01) %>%
  dplyr::top_n(10, wt=-padj)
topPathways <- bind_rows(topUp, topDown) %>%
  arrange(-ES) %>%
  pull(pathway)

plotGseaTable(
  pathways = CGP[topPathways],
  stats = ranks.gastroc,
  fgseaRes = fgseaRes,
  gseaParam = 0.5,
  render = TRUE
) %>%
  ggpubr::as_ggplot() # needed since, for whatever reason only `NULL` gets returned if `plotGseaTable` is rendered inline
```

