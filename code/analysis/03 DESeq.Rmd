---
title: "03 DESeq"
author: "Nick Diercksen"
output:
  html_notebook:
    code_folding: hide
    toc: yes
    toc_float: yes
    df_print: paged
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(DESeq2)
library(SummarizedExperiment)
library(EnhancedVolcano)
```

# DESeq

## loading data

For the DESeq2 analysis, the raw, prefiltered counts will be used.

```{r}
se.gastroc <- readRDS("./data/Robjects/01_se.gastroc.rds")
se.soleus <- readRDS("./data/Robjects/01_se.soleus.rds")

counts.gastroc <- se.gastroc[rowData(se.gastroc)$filtered,] %>% assay()
counts.soleus <- se.soleus[rowData(se.soleus)$filtered,] %>% assay()
metadata <- colData(se.gastroc)
```


## preparing DDS objects

```{r message=FALSE, warning=FALSE}
createDDSObject <- function(counts, metadata) {
  # select sample columns
  reorder_index <- match(rownames(metadata), colnames(counts))
  counts <- counts[,reorder_index]
  
  # Check metadata consistency
  all(rownames(metadata) %in% colnames(counts)) %>%
    assertthat::assert_that(., msg = "metadata and count table do not match")
  
  ## DESeq2 object
  dds <- DESeqDataSetFromMatrix(countData = counts,
                                colData = metadata,
                                design = ~ genotype)
  
  return( DESeq(dds) )
}

# creating DESeq Objects
dds.gastroc <- createDDSObject(counts.gastroc, metadata)
dds.soleus <- createDDSObject(counts.soleus, metadata)

# creating SESeqg Objects from SE
# dds.gastroc.se <- DESeqDataSet(se.gastroc, design = ~ genotype)
# dds.soleus.se <- DESeqDataSet(se.soleus, design = ~ genotype)
```

## MA-Plots

### gastroc

```{r message=FALSE, warning=FALSE}
plotMA(dds.gastroc)
```


### soleus

```{r message=FALSE, warning=FALSE}
plotMA(dds.soleus)
```

## Dispersion Estimates

### gastroc

```{r}
plotDispEsts(dds.gastroc)
```

### soleus

```{r}
plotDispEsts(dds.soleus)
```

## Results

```{r}
res.gastroc <- results(dds.gastroc, alpha = 0.05)
res.soleus <- results(dds.soleus, alpha = 0.05)


head(res.gastroc)
head(res.soleus)
```

### top significant diff. genes

```{r}
topGenes.gastroc <- as.data.frame(res.gastroc) %>%
  tibble::rownames_to_column("GeneID") %>%
  top_n(100, wt = -padj) %>%
  arrange(padj)

topGenes.soleus <- as.data.frame(res.soleus) %>%
  tibble::rownames_to_column("GeneID") %>%
  top_n(100, wt = -padj) %>%
  arrange(padj)

knitr::kable(head(topGenes.gastroc), caption = "gastroc")
knitr::kable(head(topGenes.soleus), caption = "soleus")
```
### p-values

```{r}
hist(res.gastroc$pvalue, main = "gastroc")
hist(res.soleus$pvalue, main = "soleus")
```

## Volcano Plot

```{r fig.width=4, fig.height=4}

volcanoPlot <- function(result, se, pCutoff = 0.05, FCutoff = 2.5, tissue = character()) {
  gene_names <-
    rowData(se)[rownames(result), c("gene_name"), drop = F]
  results.df <- result %>%
    as.data.frame() %>%
    dplyr::arrange(padj)
  
  # top 10 gene labels for respectively up and down regulation
  labs.up <- results.df[results.df$log2FoldChange > FCutoff, ] %>%
    rownames() %>% .[1:10] %>% gene_names[., c("gene_name")]
  labs.down <- results.df[results.df$log2FoldChange < -FCutoff, ] %>%
    rownames() %>% .[1:10] %>% gene_names[., c("gene_name")]
  selectLab <- c(labs.up, labs.down, "Nfe2l1") %>% unique()
  
  # custom colors:
  keyvals <- ifelse(
    result$log2FoldChange < -FCutoff &
      result$padj < pCutoff,
    'royalblue',
    ifelse(
      result$log2FoldChange > FCutoff &
        result$padj < pCutoff,
      'red',
      'gray'
    )
  )
  keyvals[is.na(keyvals)] <- 'gray'
  names(keyvals)[keyvals == 'red'] <- 'high'
  names(keyvals)[keyvals == 'gray'] <- 'mid'
  names(keyvals)[keyvals == 'royalblue'] <- 'low'
  
  vlc.plt <- EnhancedVolcano(
    result,
    x = 'log2FoldChange',
    y = 'padj',
    title = 'WT vs KO: Nfe2l1 knockout',
    subtitle = ifelse(isEmpty(tissue), "", paste0('tissue: ', tissue)),
    xlab = 'padj',
    pCutoff = pCutoff,
    FCcutoff = FCutoff,
    legendPosition = 'right',
    pointSize = 2,
    colCustom = keyvals,
    lab = make.names(gene_names$gene_name),
    selectLab = make.names(selectLab),
    labSize = 3,
    boxedLabels = TRUE,
    parseLabels = TRUE,
    drawConnectors = TRUE,
    max.overlaps = Inf
  )
  
  return(vlc.plt)
}

volcanoPlot(res.gastroc, se.gastroc, pCutoff = 0.05, FCutoff = 2.5, tissue = "gastrocnemius")

volcanoPlot(res.soleus, se.soleus, pCutoff = 0.05, FCutoff = 2.5, tissue = "soleus")

```


Gene names beginning with a number were modified to begin with a 'X' for the
plot to be able to plot. Otherwise the following error would occur:

```{}
Error in parse(text = "2810474O19Rik") : <text>:1:8: unexpected symbol
1: 2810474O19Rik
           ^
```

# save R ojects

```{r}
save(dds.gastroc, dds.soleus, res.gastroc, res.soleus, file = "./data/Robjects/03_DDS.RData")
```



# Final Questions
DESeq:

* is shrinking necessary? (`lfcShrink`)
* `resultsNames(dds)` yields "Intercept" and "genotype_WT_vs_KO". What is "Intercept"?
* is the design done properly? is "WT vs KO" correct?
  * 

# TODO:
* how to allow labels (gene names) in volcanoPlot beginning with a number?