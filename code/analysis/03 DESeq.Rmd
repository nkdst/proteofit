---
title: "03 DESeq"
author: "Nick Diercksen"
output:
  html_notebook:
    code_folding: hide
    toc: yes
    toc_float: yes
    df_print: paged
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(DESeq2)
library(SummarizedExperiment)
library(EnhancedVolcano)
library(ggVennDiagram)
```

```{r plotSettings, include=FALSE}
customColors <- c("WT"= "#00C3C6","KO"= "#FF6C67")
```


# DESeq

## loading data

For the DESeq2 analysis, the raw, prefiltered counts will be used.

```{r}
se.gastroc <- readRDS("./data/Robjects/01_se.gastroc.rds")
se.soleus <- readRDS("./data/Robjects/01_se.soleus.rds")

counts.gastroc <- se.gastroc[rowData(se.gastroc)$filtered,] %>% assay()
counts.soleus <- se.soleus[rowData(se.soleus)$filtered,] %>% assay()
metadata <- colData(se.gastroc)
```


## preparing DDS objects

```{r message=FALSE, warning=FALSE}
createDDSObject <- function(counts, metadata) {
  # select sample columns
  reorder_index <- match(rownames(metadata), colnames(counts))
  counts <- counts[,reorder_index]
  
  # Check metadata consistency
  all(rownames(metadata) %in% colnames(counts)) %>%
    assertthat::assert_that(., msg = "metadata and count table do not match")
  
  ## DESeq2 object
  dds <- DESeqDataSetFromMatrix(countData = counts,
                                colData = metadata,
                                design = ~ genotype)
  
  return( DESeq(dds) )
}

# creating DESeq Objects
dds.gastroc <- createDDSObject(counts.gastroc, metadata)
dds.soleus <- createDDSObject(counts.soleus, metadata)

# creating SESeqg Objects from SE
# dds.gastroc.se <- DESeqDataSet(se.gastroc, design = ~ genotype)
# dds.soleus.se <- DESeqDataSet(se.soleus, design = ~ genotype)
```

## MA-Plots

### gastroc

```{r message=FALSE, warning=FALSE}
plotMA(dds.gastroc)
```

[](shrinking the log2 fold change estimates to be more accurate)
```{r message=FALSE, warning=FALSE, eval=FALSE, include=FALSE}
# TODO: see if lfcShrink would change any of the following plots (also volcano)
result <- lfcShrink(dds, coef = "genotype_WT_vs_KO")
plotMA(dds.gastroc)
```


### soleus

```{r message=FALSE, warning=FALSE}
plotMA(dds.soleus)
```

## Dispersion Estimates

### gastroc

```{r}
plotDispEsts(dds.gastroc)
```

### soleus

```{r}
plotDispEsts(dds.soleus)
```

## Results

```{r}
res.gastroc <- results(dds.gastroc, alpha = 0.05, contrast = c("genotype", "KO", "WT"))
res.soleus <- results(dds.soleus, alpha = 0.05, contrast = c("genotype", "KO", "WT"))


head(res.gastroc)
head(res.soleus)
```

### top significant diff. genes

```{r}
topGenes.gastroc <- as.data.frame(res.gastroc) %>%
  tibble::rownames_to_column("GeneID") %>%
  top_n(100, wt = -padj) %>%
  arrange(padj)

topGenes.soleus <- as.data.frame(res.soleus) %>%
  tibble::rownames_to_column("GeneID") %>%
  top_n(100, wt = -padj) %>%
  arrange(padj)

knitr::kable(head(topGenes.gastroc), caption = "gastroc")
knitr::kable(head(topGenes.soleus), caption = "soleus")
```
### p-values

```{r}
hist(res.gastroc$pvalue, main = "gastroc")
hist(res.soleus$pvalue, main = "soleus")
```

### Volcano Plot

```{r fig.width=4, fig.height=4, warning=FALSE}
volcanoPlot <- function(result, se, pCutoff = 0.05, FCutoff = 1, tissue = character()) {
  gene_names <-
    rowData(se)[rownames(result), c("gene_name"), drop = F]
  results.df <- result %>%
    as.data.frame() %>%
    dplyr::arrange(padj)
  
  # top 10 gene labels for respectively up and down regulation
  labs.up <- results.df[results.df$log2FoldChange > FCutoff, ] %>%
    rownames() %>% .[1:10] %>% gene_names[., c("gene_name")]
  labs.down <- results.df[results.df$log2FoldChange < -FCutoff, ] %>%
    rownames() %>% .[1:10] %>% gene_names[., c("gene_name")]
  selectLab <- c(labs.up, labs.down, "Nfe2l1") %>% unique() # always including "Nfe2l1"
  
  # custom colors:
  keyvals <- ifelse(
    result$log2FoldChange < -FCutoff &
      result$padj < pCutoff,
    'royalblue',
    ifelse(
      result$log2FoldChange > FCutoff &
        result$padj < pCutoff,
      'red',
      'gray'
    )
  )
  keyvals[is.na(keyvals)] <- 'gray'
  names(keyvals)[keyvals == 'red'] <- 'up regulated'
  names(keyvals)[keyvals == 'gray'] <- 'nonsignificant'
  names(keyvals)[keyvals == 'royalblue'] <- 'down regulated'
  
  vlc.plt <- EnhancedVolcano(
    result,
    x = 'log2FoldChange',
    y = 'padj',
    title = 'WT vs KO: Nfe2l1 knockout',
    subtitle = ifelse(isEmpty(tissue), "", paste0('tissue: ', tissue)),
    ylab = expression(paste(-Log[10], p[adj])),
    pCutoff = pCutoff,
    FCcutoff = FCutoff,
    legendPosition = 'right',
    pointSize = 2,
    colCustom = keyvals,
    lab = gene_names$gene_name,
    selectLab = selectLab,
    labSize = 3,
    boxedLabels = TRUE,
    drawConnectors = TRUE,
    max.overlaps = Inf
  )
  
  return(vlc.plt)
}

FCutoff = 1
pCutoff = 0.01

volcanoPlot(res.gastroc, se.gastroc, pCutoff = 0.01, FCutoff = FCutoff, tissue = "gastrocnemius")

volcanoPlot(res.soleus, se.soleus, pCutoff = 0.01, FCutoff = FCutoff, tissue = "soleus")

```



### top differential expressed genes
```{r }
setBold <- function(src, special_labs) {
  # source: https://stackoverflow.com/questions/39694490/highlighting-individual-axis-labels-in-bold-using-ggplot2
  if (!is.factor(src)) src <- factor(src)                   
  src_levels <- base::levels(src)                          
  brave <- special_labs %in% src_levels                   
  b_vec <- rep("plain", length(src_levels))              
  if (all(brave)) {                                     
    b_pos <- purrr::map_int(special_labs, ~which(.==src_levels))
    b_vec[b_pos] <- "bold"
    b_vec
  } else {
    message("setBold: no matching element found")
  }
  return(b_vec)
}

getTopExpressedEnsemblNames <-
  function(result,
           FCutoff,
           n,
           up = T) {
    .filter <- ifelse(up, `>`, `<`)
    
    subset(result, .filter(log2FoldChange, FCutoff)) %>%
      data.frame() %>%
      filter(baseMean > 100) %>%
      arrange(padj) %>%
      .[1:n, ] %>%
      rownames()
  }

boxplot.top <- function(result, dds, se, upregulated=TRUE, n = 20, FCutoff = 1, tissue ="") {
  # getting the top n regulated genes
  names.top <- getTopExpressedEnsemblNames(result, FCutoff=FCutoff, n=n, up = upregulated)
  
  counts.top <- counts(dds, normalized=T)[names.top, ]
  metadata <- colData(se) %>% as.data.frame()
  gene_names <- rowData(se)[, c("gene_name"), drop = F] %>% as.data.frame()
  
  counts.plt <-
    data.frame(counts.top) %>%
    tibble::rownames_to_column(var = "ensembl") %>%
    tidyr::gather(key = "samplename",
           value = "normalized_counts", 2:13) %>%
    merge(metadata, by.x="samplename", by.y=0) %>%
    merge(gene_names, by.x="ensembl", by.y=0)  %>%
    mutate(genotype = factor(genotype)) %>%
    mutate(genotype = relevel(genotype, "WT"))  %>% # "WT" needs to be displayed befor "KO"
    mutate(gene_name = forcats::fct_reorder(gene_name, normalized_counts, .desc = T))
  
  direction <- ifelse(upregulated, "up", "down")
  
  ggplot(counts.plt,
         aes(
           x = as.factor(gene_name),
           y = normalized_counts,
           fill = genotype
         )) +
    geom_dotplot(
      binaxis = 'y',
      stackdir = 'center',
      dotsize = 0.5,
      position = position_dodge(0.8)
    ) +
    geom_boxplot() +
    scale_y_log10() +
    xlab("Genes") +
    ylab("Normalized Counts") +
    scale_fill_manual(values = customColors) +
    ggtitle(paste0("Top ", n, " ", direction, "-regulated Genes\n tissue: ", tissue)) +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(axis.text.x = element_text(
      angle = 45,
      hjust = 1,
      face = setBold(counts.plt$gene_name, c("Nfe2l1"))
    ))
}
```

#### gastroc

```{r warning=FALSE, message=FALSE}
boxplot.top(res.gastroc, dds.gastroc, se.gastroc, upregulated = T, tissue = "gastroc")
boxplot.top(res.gastroc, dds.gastroc, se.gastroc, upregulated = F, tissue = "gastroc")
```


#### soleus

```{r warning=FALSE, message=FALSE}
boxplot.top(res.soleus, dds.soleus, se.soleus, upregulated = T, tissue = "soleus")
boxplot.top(res.soleus, dds.soleus, se.soleus, upregulated = F, tissue = "soleus")
```
### overlapping genes (Venn Diagram)
```{r vennDiagram}
ensemblToName <- function(ens, se) {
  rowData(se)[ens, "gene_name"]
}


vennDiagram.top <- function(FCutoff=1, n=20, up=T, se) {
  genes1 <- getTopExpressedEnsemblNames(res.gastroc, FCutoff = FCutoff, n, up=up)
  genes2 <- getTopExpressedEnsemblNames(res.soleus, FCutoff = FCutoff, n, up=up)
  
  overlap <- genes1[genes1 %in% genes2] %>%
    ensemblToName(se)
  
  
  
  ggVennDiagram(list(genes1, genes2), category.names = c("gastroc", "soleus"), ) +
    ggtitle(label = paste0("overlap: ", paste(overlap, collapse=", ")))
}
```

#### upregulated
```{r}
vennDiagram.top(FCutoff = FCutoff, n=20, up=T, se=se.gastroc)
```



#### downregulated
```{r}
vennDiagram.top(FCutoff = FCutoff, n=20, up=F, se=se.gastroc)
```



# save R ojects

```{r}
save(dds.gastroc, dds.soleus, res.gastroc, res.soleus, file = "./data/Robjects/03_DDS.RData")
```


# Questions

* should the boxplots be sorted after the counts, as they currently are?
