---
title: "testing"
author: "Nick Diercksen"
date: "2022-10-10"
output:
  html_document:
    df_print: paged
params:
  FCutoff:
    label: cutoff for the log2FoldChange
    value: 1
  pCutoff:
    label: "cutoff for the adjusted p-Value"
    value: 0.01
  knitting_parameters_used:
    label: helper variable for knitting, should not be changed
    value: yes
  reevaluate:
    label: Should all calculations and database lookups be done again or just e.g.
      graphics regenerated
    value: no
---

```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(echo = TRUE,
                      fig.width = 9,
                      fig.height = 9,
                      fig.retina = 2, dpi = 100)
# knitr::opts_knit$set(root.dir = rprojroot::find_root(".Rhistory"))
```


```{r parameters, include=FALSE}
if (! exists("knitting_parameters_used")) {
  # when knitting with parameters the following variables are already set
  FCutoff <- 1
  pCutoff <- 0.01
  reevaluate <- FALSE
} 
```


## some title

$x -\frac{ mean(x)}{sd(x)}$

```{r checkingStuff, warning=TRUE}
FCutoff > 0
warning("current wd: ", getwd())

# now the grDevice size
interactive()
warning("grDevice size: ", grDevices::dev.size())
```


```{r, eval=reevaluate}
load("./data/Robjects/03_DDS.RData")
```


Adjusting the size of plots, by using the chunk parameters causes some inconsistencies
when using different screen resolutions. Thus it might be better to save plots with exact
resolution.
Some relating discussions can be found here:

* [plots on different monitors](https://github.com/rstudio/rmarkdown/issues/1827)
* [true plots gist](https://gist.github.com/debruine/baa61e561935d5e0df1ea0f294399c6c)

# testing plotly
### most differential regulated pathways, both tissues


```{r}
fgseaRes.gastroc <- readRDS(file="./data/Robjects/04_fgseaRes.gastroc.rds")
fgseaRes.soleus <- readRDS(file="./data/Robjects/04_fgseaRes.soleus.rds")
```


```{r topDiff.both, warning=FALSE, fig.width = 9, fig.height = 9, fig.retina = 2, dpi = 100}
prepare_result <- function(fgseaRes, colname="NES", pCutoff) {
  fgseaRes.prep <- fgseaRes %>%
    data.frame() %>%
    filter(padj < pCutoff) %>%
    dplyr::rename(!!colname := NES) %>%
    dplyr::select(!!colname, pathway)
  return(fgseaRes.prep)
}

prep.gastroc <- prepare_result(fgseaRes.gastroc, colname="gastroc", params$pCutoff)
prep.soleus  <- prepare_result(fgseaRes.soleus,  colname="soleus", params$pCutoff)


# combining wald-Test data from both tissues and ordering in quadrants
res.combined <- merge(prep.gastroc,
                      prep.soleus,
                      by = "pathway") %>%
  mutate(diff.exp = case_when(
    gastroc < 0 & soleus < 0 ~ "both down",
    gastroc > 0 & soleus > 0 ~ "both up",
    gastroc < 0 & soleus > 0 ~ "ga down, sol up",
    gastroc > 0 & soleus < 0 ~ "ga up, sol down",
    TRUE ~ "different"
  ))

# final plot
p <- ggplot(res.combined, aes(x = gastroc, y = soleus, text=pathway)) +
  geom_vline(xintercept = 0) + 
  geom_hline(yintercept = 0) + 
  geom_point(aes(color = diff.exp)) +
  # scale_color_manual(values = c("red", "chartreuse1", "bisque", "royalblue")) +
  labs(x = "gastroc", y = "soleus") +
  # ggrepel::geom_label_repel(max.overlaps = 20) + 
  ggtitle(label = "NES")

plotly::ggplotly(p,tooltip = "all")
p
```